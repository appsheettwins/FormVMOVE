/***********************
 * CONFIGURATION
 ***********************/

const CONFIG = {
  SHEET_ID: "1XicHQ7p4mcYo-CJvKQFymqyXrMUOP68XaUD78PyqPe0",
  SHEETS: {
    FORM: "FormData",
    ACTIVITY: "Activity",
    USERS: "LineUsers",
    CHATS: "LineChats"
  },
  LINE_TOKEN: "jPbbzgu1p0FIr5O/ZCvczvlUj+QNbl7x1DBw+aAoumfuqXcm0bt2DZMJxBCDeK1YcSB1Htc7Waf34BM5biopYhTEed9cCHiV1JscVL3YddtIwdBZvmAe8B1s0mF7vZ1NE05zDMmEaqrY1k4u9AuJVgdB04t89/1O/w1cDnyilFU="
};

/***********************
 * ===== GET =====
 ***********************/
function doGet(e) {
  try {
    const mode = e.parameter.mode;
    
    console.log('=== doGet START ===');
    console.log('Mode:', mode);
    console.log('All parameters:', e.parameter);
    
    if (mode === "activity") {
      return handleGetActivities();
    } else if (mode === "search") {
      return handleSearch(e.parameter.phone);
    } else if (mode === "test") {
      return handleTest();
    } else if (mode === "fixphones") {
      return handleFixPhones();
    }

    return jsonResponse({ 
      success: false, 
      error: "Invalid mode. Use: activity, search, test, fixphones" 
    }, 400);
    
  } catch (err) {
    console.error('doGet Error:', err);
    return jsonResponse({ 
      success: false, 
      error: "Server error: " + err.message 
    }, 500);
  }
}

/***********************
 * 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
 ***********************/
function handleGetActivities() {
  try {
    console.log('Loading activities...');
    
    const ss = SpreadsheetApp.openById(CONFIG.SHEET_ID);
    const sh = ss.getSheetByName(CONFIG.SHEETS.ACTIVITY);
    
    if (!sh) {
      throw new Error("Sheet 'Activity' not found");
    }
    
    const data = sh.getDataRange().getValues();
    console.log('Total activity rows:', data.length);
    
    const result = [];
    
    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å row ‡∏ó‡∏µ‡πà 2 (skip header)
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      result.push({
        activity: row[0] || "",
        item: row[1] || "",
        travelTime: row[2] || ""
      });
    }
    
    console.log('Returning activities:', result.length);
    return jsonResponse(result);
    
  } catch (err) {
    console.error('handleGetActivities Error:', err);
    return jsonResponse({ 
      success: false, 
      error: "Error loading activities: " + err.message 
    }, 500);
  }
}

/***********************
 * 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ - ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ 0 ‡∏´‡∏≤‡∏¢
 ***********************/
function handleSearch(searchPhone) {
  try {
    console.log('=== SEARCH FUNCTION START ===');
    console.log('Searching for:', searchPhone);
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£
    if (!searchPhone) {
      return jsonResponse({ 
        success: false, 
        error: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" 
      }, 400);
    }
    
    // ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ (‡∏•‡∏ö‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)
    const cleanSearchPhone = searchPhone.replace(/\D/g, '');
    console.log('Clean search phone:', cleanSearchPhone);
    
    if (cleanSearchPhone.length < 9) {
      return jsonResponse({ 
        success: false, 
        error: "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏™‡∏±‡πâ‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ 9-10 ‡∏´‡∏•‡∏±‡∏Å)" 
      }, 400);
    }
    
    // ‡πÄ‡∏õ‡∏¥‡∏î Spreadsheet
    const ss = SpreadsheetApp.openById(CONFIG.SHEET_ID);
    const sh = ss.getSheetByName(CONFIG.SHEETS.FORM);
    
    if (!sh) {
      throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö Sheet: " + CONFIG.SHEETS.FORM);
    }
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    const lastRow = sh.getLastRow();
    const lastCol = sh.getLastColumn();
    
    console.log('FormData - Rows:', lastRow, 'Columns:', lastCol);
    
    if (lastRow <= 1) {
      return jsonResponse({ 
        success: true, 
        message: "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö",
        results: [] 
      });
    }
    
    const data = sh.getRange(1, 1, lastRow, lastCol).getValues();
    console.log('Total data rows:', data.length);
    
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô
    // ‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏î‡∏¥‡∏°:
    // [0] Date, [1] userId, [2] displayName, [3] profilename, 
    // [4] inputName, [5] phone, [6] activity, [7] item, [8] travelTime
    const PHONE_COLUMN = 5; // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå F
    const NAME_COLUMN = 4;  // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå E
    const ACTIVITY_COLUMN = 6; // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå G
    const ITEM_COLUMN = 7;     // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå H
    const TIME_COLUMN = 8;     // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå I
    
    console.log('Using column indexes:');
    console.log('- Phone column (F):', PHONE_COLUMN);
    console.log('- Name column (E):', NAME_COLUMN);
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ
    const searchPatterns = generateAllSearchPatterns(cleanSearchPhone);
    console.log('Search patterns:', searchPatterns);
    
    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    const results = [];
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const rawPhone = row[PHONE_COLUMN];
      
      if (!rawPhone && rawPhone !== 0) continue;
      
      // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÉ‡∏ô Sheet ‡πÄ‡∏õ‡πá‡∏ô string
      let phoneStr = String(rawPhone);
      
      console.log(`Row ${i+1}: Raw phone = "${phoneStr}"`);
      
      // ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÉ‡∏ô Sheet
      const cleanRowPhone = phoneStr.replace(/\D/g, '');
      
      if (!cleanRowPhone) continue;
      
      console.log(`  Cleaned: "${cleanRowPhone}"`);
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
      for (const pattern of searchPatterns) {
        console.log(`  Comparing with pattern: "${pattern}"`);
        
        if (cleanRowPhone === pattern) {
          console.log(`  MATCH FOUND! Pattern "${pattern}" matches`);
          
          // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
          const result = {
            timestamp: row[0] ? new Date(row[0]).toISOString() : '',
            inputName: row[NAME_COLUMN] || '',
            phone: formatPhoneDisplay(phoneStr),
            activity: row[ACTIVITY_COLUMN] || '',
            item: row[ITEM_COLUMN] || '',
            travelTime: row[TIME_COLUMN] || '',
            rowNumber: i + 1,
            rawPhone: phoneStr,
            cleanedPhone: cleanRowPhone
          };
          
          results.push(result);
          break; // ‡∏û‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô
        }
      }
    }
    
    console.log('Total matches found:', results.length);
    
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠ debug
    if (results.length === 0) {
      console.log('=== DEBUG: SAMPLE PHONE DATA ===');
      const sampleSize = Math.min(10, data.length - 1);
      for (let i = 1; i <= sampleSize; i++) {
        const row = data[i];
        const samplePhone = row[PHONE_COLUMN];
        const sampleName = row[NAME_COLUMN];
        console.log(`Row ${i+1}: Name="${sampleName}", Phone="${samplePhone}", Cleaned="${String(samplePhone).replace(/\D/g, '')}"`);
      }
      
      return jsonResponse({
        success: true,
        message: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå " + searchPhone,
        results: [],
        debug: {
          searchPhone: searchPhone,
          cleanSearchPhone: cleanSearchPhone,
          searchPatterns: searchPatterns,
          totalRowsChecked: data.length - 1,
          sampleSize: sampleSize
        }
      });
    }
    
    return jsonResponse({
      success: true,
      message: `‡∏û‡∏ö ${results.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`,
      results: results
    });
    
  } catch (err) {
    console.error('handleSearch Error:', err);
    console.error('Stack:', err.stack);
    return jsonResponse({
      success: false,
      error: "‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á: " + err.message
    }, 500);
  }
}

/***********************
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
 ***********************/
function generateAllSearchPatterns(phone) {
  const patterns = new Set();
  
  // 1. ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
  patterns.add(phone);
  
  // 2. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô 10 ‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢ 0
  if (phone.length === 10 && phone.startsWith('0')) {
    // ‡∏ï‡∏±‡∏î 0 ‡∏≠‡∏≠‡∏Å (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 9 ‡∏´‡∏•‡∏±‡∏Å)
    patterns.add(phone.substring(1));
    
    // ‡πÄ‡∏ï‡∏¥‡∏° 66 ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ (‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÑ‡∏ó‡∏¢)
    patterns.add('66' + phone.substring(1));
  }
  
  // 3. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô 9 ‡∏´‡∏•‡∏±‡∏Å
  if (phone.length === 9) {
    // ‡πÄ‡∏ï‡∏¥‡∏° 0 ‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (‡πÄ‡∏õ‡πá‡∏ô 10 ‡∏´‡∏•‡∏±‡∏Å)
    patterns.add('0' + phone);
    
    // ‡πÄ‡∏ï‡∏¥‡∏° 66 ‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤
    patterns.add('66' + phone);
  }
  
  // 4. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô 8 ‡∏´‡∏•‡∏±‡∏Å (‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ 2 ‡∏´‡∏•‡∏±‡∏Å)
  if (phone.length === 8) {
    patterns.add('0' + phone);
    patterns.add('66' + phone);
  }
  
  // 5. ‡∏•‡∏≠‡∏á‡∏ï‡∏±‡∏î‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏£‡∏Å‡∏™‡∏∏‡∏î‡∏≠‡∏≠‡∏Å (‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏≤‡∏à‡∏°‡∏µ prefix ‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®)
  if (phone.length > 9) {
    patterns.add(phone.slice(-9)); // ‡πÄ‡∏≠‡∏≤ 9 ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
    patterns.add(phone.slice(-10)); // ‡πÄ‡∏≠‡∏≤ 10 ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
  }
  
  return Array.from(patterns);
}

/***********************
 * ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
 ***********************/
function formatPhoneDisplay(phone) {
  if (!phone) return '';
  
  const clean = String(phone).replace(/\D/g, '');
  
  if (clean.length === 10 && clean.startsWith('0')) {
    return clean;
  } else if (clean.length === 9) {
    return '0' + clean;
  } else if (clean.length === 8) {
    return '0' + clean;
  }
  
  return clean;
}

/***********************
 * 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö
 ***********************/
function handleTest() {
  try {
    console.log('=== TEST FUNCTION ===');
    
    const ss = SpreadsheetApp.openById(CONFIG.SHEET_ID);
    const sh = ss.getSheetByName(CONFIG.SHEETS.FORM);
    
    if (!sh) {
      return jsonResponse({ error: "Sheet not found: " + CONFIG.SHEETS.FORM });
    }
    
    const lastRow = sh.getLastRow();
    const lastCol = sh.getLastColumn();
    
    console.log('Sheet:', CONFIG.SHEETS.FORM);
    console.log('Rows:', lastRow, 'Columns:', lastCol);
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á
    const sampleData = [];
    const numRowsToShow = Math.min(10, lastRow - 1);
    
    if (numRowsToShow > 0) {
      const data = sh.getRange(2, 1, numRowsToShow, lastCol).getValues();
      
      for (let i = 0; i < data.length; i++) {
        const row = data[i];
        const phoneRaw = row[5];
        const phoneStr = String(phoneRaw);
        const phoneClean = phoneStr.replace(/\D/g, '');
        
        const rowObj = {
          row: i + 2,
          timestamp: row[0],
          name: row[4] || "",
          phoneRaw: phoneRaw,
          phoneString: phoneStr,
          phoneClean: phoneClean,
          phoneLength: phoneClean.length,
          startsWithZero: phoneClean.startsWith('0'),
          activity: row[6] || ""
        };
        sampleData.push(rowObj);
        
        console.log(`Row ${i+2}: Name="${row[4]}", Phone="${phoneStr}" (clean: ${phoneClean}, length: ${phoneClean.length})`);
      }
    }
    
    // ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    const allData = sh.getRange(2, 1, lastRow-1, lastCol).getValues();
    const phoneAnalysis = {
      total: allData.length,
      byLength: {},
      hasZeroPrefix: 0,
      noZeroPrefix: 0
    };
    
    allData.forEach(row => {
      const phoneStr = String(row[5] || '');
      const cleanPhone = phoneStr.replace(/\D/g, '');
      const length = cleanPhone.length;
      
      phoneAnalysis.byLength[length] = (phoneAnalysis.byLength[length] || 0) + 1;
      
      if (cleanPhone.startsWith('0')) {
        phoneAnalysis.hasZeroPrefix++;
      } else {
        phoneAnalysis.noZeroPrefix++;
      }
    });
    
    return jsonResponse({
      success: true,
      sheetInfo: {
        name: CONFIG.SHEETS.FORM,
        totalRows: lastRow,
        totalColumns: lastCol,
        dataRows: lastRow - 1
      },
      phoneAnalysis: phoneAnalysis,
      sampleData: sampleData,
      searchTips: {
        try9digit: "‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢ 9 ‡∏´‡∏•‡∏±‡∏Å (‡∏ï‡∏±‡∏î 0 ‡∏≠‡∏≠‡∏Å)",
        try10digit: "‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢ 10 ‡∏´‡∏•‡∏±‡∏Å (‡πÄ‡∏ï‡∏¥‡∏° 0 ‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤)",
        commonPatterns: ["0928260072", "928260072", "0812345678", "812345678"]
      }
    });
    
  } catch (err) {
    console.error('handleTest Error:', err);
    return jsonResponse({ 
      success: false, 
      error: "Test error: " + err.message 
    });
  }
}

/***********************
 * 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÉ‡∏ô Sheet (‡πÄ‡∏û‡∏¥‡πà‡∏° ' ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤)
 ***********************/
function handleFixPhones() {
  try {
    console.log('=== FIX PHONES FUNCTION ===');
    
    const ss = SpreadsheetApp.openById(CONFIG.SHEET_ID);
    const sh = ss.getSheetByName(CONFIG.SHEETS.FORM);
    
    if (!sh) {
      return jsonResponse({ error: "‡πÑ‡∏°‡πà‡∏û‡∏ö Sheet" });
    }
    
    const lastRow = sh.getLastRow();
    if (lastRow <= 1) {
      return jsonResponse({ message: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç" });
    }
    
    const data = sh.getRange(2, 1, lastRow-1, 9).getValues(); // 9 columns (A-I)
    let fixedCount = 0;
    let unchangedCount = 0;
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const phone = row[5]; // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå F (index 5)
      
      if (!phone && phone !== 0) continue;
      
      const phoneStr = String(phone).trim();
      
      // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ' ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°
      if (!phoneStr.startsWith("'") && phoneStr.length > 0) {
        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        console.log(`Row ${i+2}: Fixing phone "${phoneStr}" -> "'${phoneStr}"`);
        
        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô Sheet
        sh.getRange(i + 2, 6).setValue("'" + phoneStr); // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå F = column 6
        fixedCount++;
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        SpreadsheetApp.flush();
        const updatedValue = sh.getRange(i + 2, 6).getValue();
        console.log(`  Updated to: "${updatedValue}"`);
      } else {
        unchangedCount++;
      }
    }
    
    return jsonResponse({
      success: true,
      message: `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`,
      stats: {
        totalRows: lastRow - 1,
        fixed: fixedCount,
        unchanged: unchangedCount
      },
      note: "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏° ' ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤ 0 ‡∏´‡∏≤‡∏¢"
    });
    
  } catch (err) {
    console.error('handleFixPhones Error:', err);
    return jsonResponse({ 
      success: false, 
      error: "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message 
    });
  }
}

/***********************
 * ===== POST =====
 ***********************/
function doPost(e) {
  try {
    console.log('=== doPost START ===');
    
    const body = JSON.parse(e.postData.contents);
    console.log('Request body type:', body.events ? 'LINE Webhook' : 'Form Submission');

    // üëâ 1) LINE OA Webhook
    if (body.events) {
      console.log('Processing LINE webhook');
      handleLineWebhook(body);
      return ContentService.createTextOutput("OK");
    }

    // üëâ 2) LIFF / FORM Submission
    console.log('Processing form submission');
    const result = handleFormSubmit(body);
    
    console.log('Form submission result:', result);
    return jsonResponse({ 
      success: true, 
      message: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
      debug: result 
    });

  } catch (err) {
    console.error('doPost Error:', err);
    return jsonResponse({ 
      success: false, 
      error: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message 
    }, 500);
  }
}

/***********************
 * FORM HANDLER - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏≤‡∏¢ (‡πÄ‡∏û‡∏¥‡πà‡∏° ' ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)
 ***********************/
function handleFormSubmit(data) {
  try {
    console.log('=== FORM SUBMISSION HANDLER ===');
    console.log('Form data received:', data);
    
    const ss = SpreadsheetApp.openById(CONFIG.SHEET_ID);
    const sh = ss.getSheetByName(CONFIG.SHEETS.FORM);
    
    if (!sh) {
      throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö Sheet: " + CONFIG.SHEETS.FORM);
    }
    
    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° ' ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô 0 ‡∏´‡∏≤‡∏¢
    const phoneToSave = data.phone ? "'" + data.phone.trim() : "";
    
    console.log('Original phone:', data.phone);
    console.log('Phone to save (with apostrophe):', phoneToSave);
    
    const timestamp = new Date();
    
    const rowData = [
      timestamp,                             // A: Timestamp
      data.userId || "",                     // B: User ID
      data.displayName || "",                // C: Display Name
      data.profilename || "",                // D: Profile URL
      data.inputName || "",                  // E: ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•
      phoneToSave,                           // F: ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ (‡∏°‡∏µ ' ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤)
      data.activity || "",                   // G: ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
      data.item || "",                       // H: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
      data.travelTime || "",                 // I: ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á
      ""                                     // J: ‡∏ß‡πà‡∏≤‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á)
    ];
    
    console.log('Full row data:', rowData);
    
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Sheet
    sh.appendRow(rowData);
    
    // ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à
    SpreadsheetApp.flush();
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    const lastRow = sh.getLastRow();
    const savedRow = sh.getRange(lastRow, 1, 1, rowData.length).getValues()[0];
    
    console.log('Saved to row', lastRow);
    console.log('Saved phone value:', savedRow[5]);
    console.log('Saved phone type:', typeof savedRow[5]);
    
    // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
    return {
      saved: true,
      rowNumber: lastRow,
      phoneSaved: savedRow[5],
      timestamp: timestamp
    };
    
  } catch (err) {
    console.error('handleFormSubmit Error:', err);
    throw err;
  }
}

/***********************
 * LINE WEBHOOK HANDLER (‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
 ***********************/
function handleLineWebhook(body) {
  const ss = SpreadsheetApp.openById(CONFIG.SHEET_ID);
  const shUsers = ss.getSheetByName(CONFIG.SHEETS.USERS);
  const shChats = ss.getSheetByName(CONFIG.SHEETS.CHATS);

  const users = shUsers.getDataRange().getValues();

  body.events.forEach(ev => {
    const userId = ev.source?.userId || "";
    if (!userId) return;

    const msgType = ev.message?.type || "event";
    const msgText = ev.message?.text || "";
    const replyToken = ev.replyToken || "";

    // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    shChats.appendRow([
      new Date(),
      userId,
      msgType,
      msgText,
      replyToken
    ]);

    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à user ‡∏ã‡πâ‡∏≥
    const idx = users.findIndex(r => r[0] === userId);
    const profile = getLineProfile(userId);

    if (idx === -1) {
      shUsers.appendRow([
        userId,
        profile.displayName || "",
        profile.pictureUrl || "",
        profile.statusMessage || "",
        new Date()
      ]);
    } else {
      shUsers.getRange(idx + 1, 2, 1, 4).setValues([[
        profile.displayName || "",
        profile.pictureUrl || "",
        profile.statusMessage || "",
        new Date()
      ]]);
    }
  });
}

/***********************
 * GET LINE PROFILE (‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
 ***********************/
function getLineProfile(userId) {
  const url = "https://api.line.me/v2/bot/profile/" + userId;
  const res = UrlFetchApp.fetch(url, {
    headers: {
      Authorization: "Bearer " + CONFIG.LINE_TOKEN
    },
    muteHttpExceptions: true
  });

  if (res.getResponseCode() !== 200) {
    return {};
  }

  return JSON.parse(res.getContentText());
}

/***********************
 * JSON RESPONSE HELPER
 ***********************/
function jsonResponse(obj, statusCode = 200) {
  const response = ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
  
  if (statusCode !== 200) {
    response.setStatusCode(statusCode);
  }
  
  return response;
}

/***********************
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
 ***********************/
function testSearchSystem() {
  console.log('=== COMPREHENSIVE SEARCH TEST ===');
  
  const testCases = [
    { input: "0928260072", description: "10 ‡∏´‡∏•‡∏±‡∏Å ‡∏°‡∏µ 0 ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤" },
    { input: "928260072", description: "9 ‡∏´‡∏•‡∏±‡∏Å ‡πÑ‡∏°‡πà‡∏°‡∏µ 0 ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤" },
    { input: "0812345678", description: "‡πÄ‡∏ö‡∏≠‡∏£‡πå 10 ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ" },
    { input: "812345678", description: "‡πÄ‡∏ö‡∏≠‡∏£‡πå 9 ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ" }
  ];
  
  const results = {};
  
  testCases.forEach(testCase => {
    console.log(`\n=== Testing: ${testCase.description} (${testCase.input}) ===`);
    try {
      const searchResult = handleSearch(testCase.input);
      results[testCase.input] = {
        description: testCase.description,
        success: searchResult.success || false,
        matches: searchResult.results ? searchResult.results.length : 0,
        message: searchResult.message || searchResult.error
      };
    } catch (err) {
      results[testCase.input] = {
        description: testCase.description,
        success: false,
        error: err.message
      };
    }
  });
  
  console.log('\n=== TEST RESULTS SUMMARY ===');
  console.log(JSON.stringify(results, null, 2));
  
  return results;
}
