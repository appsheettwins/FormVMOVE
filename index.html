<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>LIFF Form v1.3</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body{
  margin:0;
  font-family:sans-serif;
  background:linear-gradient(135deg,#6366f1,#22d3ee);
}
.card{
  max-width:420px;
  margin:20px auto;
  background:#fff;
  border-radius:20px;
  padding:20px;
  box-shadow:0 15px 40px rgba(0,0,0,.2);
}
img{
  width:90px;
  border-radius:50%;
  display:block;
  margin:auto;
}
h3{text-align:center;margin:10px 0}
label{margin-top:12px;display:block;font-weight:600}
input,select{
  width:100%;
  padding:12px;
  margin-top:6px;
  border-radius:12px;
  border:1px solid #ddd;
  font-size:16px;
}
button{
  width:100%;
  margin-top:16px;
  padding:14px;
  font-size:17px;
  border:none;
  border-radius:14px;
  background:linear-gradient(135deg,#22c55e,#16a34a);
  color:#fff;
}
.summary{display:none;text-align:center}
.summary p{margin:6px 0}
</style>
</head>

<body>
<div class="card">

<div id="form">
  <img id="pic">
  <h3 id="lineName"></h3>

  <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
  <input id="inputName" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">

  <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
  <input id="phone" type="tel" inputmode="numeric" maxlength="10" placeholder="0xxxxxxxxx">

  <label>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
  <select id="activity" onchange="updateItems()">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° --</option>
  </select>

  <label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
  <select id="item">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>
  </select>

  <button onclick="save()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
</div>

<div id="summary" class="summary">
  <h3>‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h3>
  <p id="sum"></p>
  <button onclick="resetForm()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</button>
</div>

</div>

<script>
const LIFF_ID = "2008940385-hkDtMTsg";
const GAS_URL = "https://script.google.com/macros/s/AKfycbzHGWEA9JYbd1e9-cGnod10qrWuy-hz39IEDd1DhjkCa8bRP-D4qVLkGXNQbV2dcjNI/exec";

let profile={}, activityMap={};

async function init(){
  await liff.init({ liffId: LIFF_ID });
  if(!liff.isLoggedIn()) return liff.login();

  profile = await liff.getProfile();
  pic.src = profile.pictureUrl;
  lineName.innerText = profile.displayName;

  loadActivities();
}

async function loadActivities(){
  const r = await fetch(GAS_URL+"?mode=activity");
  const data = await r.json();

  activityMap = {};
  data.forEach(x=>{
    if(!activityMap[x.activity]) activityMap[x.activity]=[];
    activityMap[x.activity].push(x.item);
  });

  Object.keys(activityMap).forEach(a=>{
    activity.innerHTML += `<option value="${a}">${a}</option>`;
  });
}

function updateItems(){
  item.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>`;
  (activityMap[activity.value]||[]).forEach(i=>{
    item.innerHTML += `<option value="${i}">${i}</option>`;
  });
}

async function save(){
  const payload={
    userId:profile.userId,
    displayName:profile.displayName,
    profilename:profile.displayName,
    inputName:inputName.value,
    phone:phone.value,
    activity:activity.value,
    item:item.value
  };

  const r = await fetch(GAS_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(payload)
  });
  const res = await r.json();
  if(!res.success) return alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

  form.style.display="none";
  summary.style.display="block";
  sum.innerHTML=`
  üë§ ${payload.inputName}<br>
  üìû ${payload.phone}<br>
  üéØ ${payload.activity}<br>
  üìå ${payload.item}`;
}

function resetForm(){ location.reload(); }

window.onload = init;
</script>
</body>
</html>
